var Ap=new Class({Implements:[Options],options:{formId:null,startApId:null,resultId:null,usersCoundId:null,buttons:{calcPeople:null},itemsAp:{icon:[300,600,900,1200],seal:[600,1200,1800,2400],cup:[1200,2400,3600,4800],crown:[2400,4800,7200,9600]},users:[],usersItems:[],usersGroupLegend:null,iterationN:0,groupNowApId:null,shablon:{iterationBlock:'<div><a href="#iteration-{iterationN}" name="iteration-{iterationN}" onclick="$(\'iteration-{iterationN}\').toggleClass(\'hide\');">Распределение #{iterationN}</a><div id="iteration-{iterationN}" class="iteration-conteiner">{block}</div></div>',block:'<div class="group-block"><div class="group-block-title left">{userId}<span>{userAp}</span><small>+{userAddAp}</small></div><div class="group-block-items right">{items}</div><div class="clear"></div></div><hr class="space" />',items:'<div class="group-block-item"><img src="/images/ap/{itemName}_{itemN}.png" />{itemFullName} <span>{itemAp} APs</span><div class="clear"></div></div>',groupNowAp:"<div>{userId} &mdash; {userAp} Aps</div>"}},startOptions:{},initialize:function(a){this.setOptions(a);this.startOptions=Object.clone(this.options);var b=this;$$("#"+this.options.formId+" input[type='text'], #"+this.options.startApId+", #"+this.options.usersCoundId).addEvents({focus:function(){var c=Number.from($(this).get("value"));if(!c){$(this).set("value","")}},blur:function(){var c=Number.from($(this).get("value"));if(!c){$(this).set("value","0")}},keyup:function(){$(b.options.resultId).set("text",b.calc())},keypress:function(c){var c=new Event(c);if(c.code<=31||(c.code>=48&&c.code<=57)){return true}else{c.stopPropagation();c.stop();return false}}});if(this.options.buttons.calcPeople){this.options.buttons.calcPeople.addEvent("click",function(c){b.calcPersone();c.stop();return false})}$("clear").addEvent("click",function(c){b.clear();c.stop();return false});return this},calc:function(){if(!$(this.options.formId)){throw new Error("Can't found form with id '"+this.options.formId+"'")}var a=$(this.options.formId).serialize(true);var g=0;var c=($(this.options.startApId))?Number.from($(this.options.startApId).get("value")):0;if(undefined==a.items){return 0}a=a.items;var f=this.options.itemsAp;for(var h in a){for(var e in a[h]){if(undefined!=f[h][e]){var b=a[h][e];var d=Number.from(f[h][e]);g+=(null!=d)?(b*d):0}}}return(g+c)},calcPersone:function(){var k=Number.from($(this.options.usersCoundId).get("value"));if(!k){throw new Error("userCound is empty")}var h=$(this.options.formId).serialize(true);if(!h.items){throw new Error("items is empty")}var j=this.options.itemsAp;var e=[];var f=0;Object.each(h.items,function(m,l){Object.each(m,function(n,q){var o=j[l][q];for(var p=0;p<n;p++){e=Array.append([{ap:o,name:l,n:q}],e);f+=o}})});var a=this.options.users;var d=f/k;var c=Array.clone(this.options.usersItems);for(var g=0;g<k;g++){if(undefined==a[g]){a[g]=0}if(undefined==c[g]){c[g]=[]}if(a[g]>=d){continue}for(var i in e){if(e[i]){if((a[g]+e[i].ap)<=d){a[g]+=e[i].ap;c[g].append([e[i]]);e[i]=null}}if(a[g]>=d){break}}}var b=function(n){var m=null,l=null;n.each(function(p,o){if(null==m){m=o;l=p;return}if(p<l){m=o;l=p}});return{key:m,value:l}};e.each(function(m){if(m){var l=b(a);a[l.key]+=m.ap;if(undefined==c[l.key]){c[l.key]=[]}c[l.key].append([m])}});this.addPerconeResultLine(a,c)},clear:function(){this.setOptions(this.startOptions);$(this.options.resultId).set("text","0");$$("input[type=text]").set("value","0");$(this.options.usersGroupLegend).set("html","");$(this.options.groupNowApId).set("html","")},clearToNext:function(){$(this.options.resultId).set("text","0");$$("input[type=text]").set("value","0")},addPerconeResultLine:function(f,e){var c=this;if(!c.options.usersGroupLegend){throw new Error("usersGroupLegend is null")}var a="";f.each(function(k,h){var i="";var g=0;e[h].each(function(m){var l=String.from(c.options.shablon.items);l=l.substitute({itemName:m.name,itemN:m.n,itemAp:m.ap,itemFullName:"test"});g+=m.ap;i+=l});var j=String.from(c.options.shablon.block);j=j.substitute({userId:h+1,userAp:k,userAddAp:g,iterationN:c.options.iterationN,items:i});a+=j});var d=String.from(c.options.shablon.iterationBlock);d=d.substitute({iterationN:c.options.iterationN,block:a});c.options.iterationN++;$$(".iteration-conteiner").addClass("hide");var b=$(c.options.usersGroupLegend);b.set("html",b.get("html")+d);this.clearToNext();this.showUsersNowAp()},showUsersNowAp:function(){var c=this.options.users;var b=this;var a="";c.each(function(e,d){a+=String.from(b.options.shablon.groupNowAp).substitute({userId:(d+1),userAp:e})});$(b.options.groupNowApId).set("html",a)}});